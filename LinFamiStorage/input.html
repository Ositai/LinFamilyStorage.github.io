<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Form</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj" crossorigin="anonymous"></script>
    <!-- Include Bootstrap CSS JS for second confirm model-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- 引用Bootstrap Library Date picker -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js"></script>

    <!-- 載入共用部分，靜態部署用 -->
    <link rel="stylesheet" href="https://ositai.github.io/LinFamilyStorage.github.io/LinFamiStorage/common.css">
    <script src="https://ositai.github.io/LinFamilyStorage.github.io/LinFamiStorage/common.js" defer></script>

    <script>
      /////// 入庫功能 ///////
      // 檢查必填
      function requireTest(){
        let name = document.getElementById('name').value
        let numberAdd = document.getElementById('numAdd').value
        let price = document.getElementById('price').value
        let numMin = document.getElementById('numMin').value
        let expireDay = document.getElementById('expireDay').value
        let leftDay = document.getElementById('leftDay').value

        if (!name){
          alert('物品欄位空白')
          return
        } else if (!numberAdd){
          alert('數量為空白')
          return
        } 
        if (!price || !numMin){
          alert('價格與預期庫存未填將默認為0')
        }
        showModel()
      }

      // 顯示二次確認視窗
      function showModel(){
        let name = document.getElementById('name').value
        let area = document.getElementById('area').value
        let position = document.getElementById('posi').value
        let price = document.getElementById('price').value
        let numberAdd = document.getElementById('numAdd').value
        let numberMin = document.getElementById('numMin').value
        let expireDay = document.getElementById('expireDay').value
        let leftDay = document.getElementById('leftDay').value
        let buyDay = document.getElementById('buyDay').value

        // 避免時間空白
        if (!expireDay && !leftDay){
          leftDay = '無期限'
          expireDay = '無期限'
        } else if (!expireDay){
          let bDay = new Date(buyDay).getTime()
          expireDay = new Date(bDay + leftDay*1000*60*60*24)
          // 修正形式
          if (expireDay.getMonth()>8){
            dash1 = '-'    
          } else {dash1 = '-0'}
          if (expireDay.getDate()<10){
            dash2 = '-0'
          } else {dash2 = '-'}
          expireDay = expireDay.getFullYear() + dash1 + (expireDay.getMonth()+1) + dash2 + expireDay.getDate()      
        } else { //只有填剩餘日期
          leftDay = (new Date(expireDay).getTime() - new Date(buyDay).getTime())/1000/60/60/24
        }

        if (!price){price=0}
        if (!numberMin){numberMin=0}

        let dataArr = [[name,'物品名'],[area,'區域'],[position,'位置'],[price,'價格'],[numberAdd,'新增數量'],
        [numberMin,'庫存下限'],[buyDay,'購買日期'],[expireDay,'過期日期'],[leftDay,'保存時長']]

        let inputData = dataArr
          .map(data =>
            `${data[1]} : ${data[0]}`
          )
          .join('\n')

        document.getElementById('modelContent')
          .innerText = inputData;
        $('#confirmationModal').modal('toggle')
        return undefined
      }

      /////// 自動比對功能 ////////
      // 顯示搜尋結果表格
      function displayResult(dataArray){
        
        if (dataArray && dataArray!==undefined && dataArray.length !=0){
          
          // 如果有結果，定義顯示格式
          let headerInput = "<p style='text-align: center'>有重複名稱的庫存，是否併入?</p>\n"+
            "<table class='table table-sm table-striped' id='dtable' style='font-size: 20px;'>"+
            "<thead style='white-space: nowrap;'>"+"<tr>"+
            // headers
            `${tableHeader}`+"</tr></thead>"

          let tableBody = ''
          // 迴圈顯示表格元素，並儲存area與index          
          dataArray.forEach(arr => {
            dataArea.push(arr.area)
            dataIndex.push(arr.index)

            let tableRowBody = arr.data
              .map(dat => {
                `<td>${dat}</td>`
              }).join()
            tableBody +=  `<tr>${tableRowBody}<td>`+
                          '<input type="radio" name=replaceCheck>'+ //合併至已有庫存checkbox
                          '</td></tr>'
          })

          let result = `${headerInput}${tableBody}</table>`

          let div = document.getElementById('search-results')
          div.innerHTML = result
          div.style.display = 'block'

          // 顯示更新庫存量按鈕
          const showButton = document.getElementById('updateNum')
          showButton.style.display = 'block'

          // 輸入進隱藏變數
          document.getElementById('dataArea').value = dataArea
          document.getElementById('dataIndex').value = dataIndex
        } else{
          let div = document.getElementById('search-results')
          div.innerHTML = '查無此庫存'
        }
        return undefined
      }

      // 傳送新增庫存資料
      function getValues(){
        let name = document.getElementById('name').value
        let area = document.getElementById('area').value
        let position = document.getElementById('posi').value
        let price = document.getElementById('price').value
        let numberAdd = document.getElementById('numAdd').value
        let numberMin = document.getElementById('numMin').value
        let expireDay = document.getElementById('expireDay').value
        let leftDay = document.getElementById('leftDay').value
        let buyDay = document.getElementById('buyDay').value

        // 避免時間空白
        if (!expireDay && !leftDay){
          leftDay = '無期限'
          expireDay = '無期限'
        } else if (!expireDay){
          let bDay = new Date(buyDay).getTime()
          expireDay = new Date(bDay + leftDay*1000*60*60*24)
          // 修正形式
          if (expireDay.getMonth()>8){
            dash1 = '-'    
          } else {dash1 = '-0'}
          if (expireDay.getDate()<10){
            dash2 = '-0'
          } else {dash2 = '-'}
          expireDay = expireDay.getFullYear() + dash1 + (expireDay.getMonth()+1) + dash2 + expireDay.getDate()
        } else { //只有填剩餘日期
          leftDay = (new Date(expireDay).getTime() - new Date(buyDay).getTime())/1000/60/60/24
        }
        if (!price){price=0}
        if (!numberMin){numberMin=0}

        let rowData={
          name:name,
          area:area,
          position:position,
          price:price,
          numberAdd:numberAdd,
          numberMin:numberMin,
          expireDay:expireDay,
          leftDay:leftDay,
          buyDay:buyDay
        }

        // upload
        fetch(scriptUrl, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: JSON.stringify({
            action: 'add',
            storageChange: rowData
            })
        })
        .then(res => res.json())
        .then(({success, message}) => {
          if (success) {
            // 上傳完後清除
            document.getElementById("myForm").reset()
            document.getElementById("search-results").style.display = 'none'
            document.getElementById('updateCheck').style.display = 'none'
            
            // 完成確認訊息
            alert(message)
            
            //重設購買日為當天日期     
            const today = new Date()
            const formattedDate = today.toISOString().slice(0, 10)
            document.getElementById('buyDay').value = formattedDate
          } else {
            console.error('Error sending data to Google Sheets:', message);
          }
        })
        .catch(error => {
          console.error('Fetch error:', error);
        });

        // 關閉二次確認對話框
        bootstrap.Modal
          .getInstance(document
            .getElementById('confirmationModal')
          )
        .hide()
        return undefined
      }
    </script>


  </head>

<!-- 布局與選項 -->
<body>
<div class="container-contact">
<h2>LinFamiStorage</h2>
<div class="row">
  <div class="col-sm-2"></div>
  <div class="col-sm-8">
    <h3>新增庫存</h3>
  </div>
  <div class="col-sm-2" style="text-align: right;">
    <button class="btn" style="font-size: 20px; max-width: fit-content;" id="backHome" onclick="linkToAdd('home')">
      🏠 Home</button>
  </div>
</div>

<!-- div class=row 為豎著切 -->
<div class="row">
  <!-- 所有(col-sm-#)表示分割成數個column，且#總和必須為12 -->
  <!-- 左至右三區域第一區(空白) -->
  <!-- <div class="col-sm-1"></div> -->

  <!-- 中間區(填寫區) -->
  <div class="col-sm-12">
    <!-- form產生表單 -->
    <form id="myForm">

      <div class="row">
        <div class="col-sm-1"></div>
        
        <!-- 物品 -->
        <div class="col-sm-10 form-group">
          <!-- id是串流物件的property -->          
          <input class="form-control" id="name" name="name"
          placeholder="物品名" type="text"
          onblur="formSender(this)"  
          required>        
          <!-- onblur   = 取消選取 -->
          <!-- required = 必填    -->
        </div>
        <div class="col-sm-1"></div> 
      </div>

      <div class="row">
      <!-- 進貨時間 -->   
        <div class="col-sm-3">
          <p>購入日期:</p>
        </div>
        <div class="col-sm-4 form-group">
          <input type="date" class="form-control" id="buyDay" placeholder="購入日期">         
          <!-- 預設為當天日期 -->
          <script>
            const today = new Date();
            const formattedDate = today.toISOString().slice(0, 10);
            document.getElementById('buyDay').value = formattedDate;
          </script>
        </div>
      </div>

      <!-- 分隔線 -->
      <div style="height: 5px; width:100%; background-color: #327570"></div>

      <div class="row">
        <!-- 有效期限 -->
        <div class="col-sm-3">
          <p>有效期限:</p>
        </div>
        <div class="col-sm-4 form-group">
          <input type="date" class="form-control" id="expireDay" placeholder="有效期限">         
        </div>
        

        <!-- 剩餘有效日期 -->
        <div class="col-sm-1">
          <p>或</p>
        </div>
        <div class="col-sm-4 form-group">
          <input type="number" class="form-control" id="leftDay" placeholder="保存時長(天)">         
        </div>
      </div>

      <!-- 分隔線 -->
      <div style="height: 5px; width:100%; background-color: #327570"></div>

      <div class="row">
        <div class="col-sm-2"></div>
        

        <!-- 先選區域 -->
        <div class="col-sm-4 form-group">         
          <label for="area" style="font-size: 20px" >庫存區域:</label>
          <select id="area" class="form-control">
            <option value="1F">1F</option>
            <option value="2F">2F</option>
            <option value="3F">3F</option>
            <option value="storage">storage</option>
          </select>
        </div>

        <!-- 再選位置 -->
        <div class="col-sm-4 form-group">
          <label for="posi style="style="font-size: 20px">庫存位置:</label>
          <select id="posi" class="form-control">
          <!-- 根據不同區域腳本生成位置清單 -->
          </select>  
        </div>
        <!-- 區域-位置 兩段式清單腳本 -->
        <script>
          const pos = {"1F":['冰箱','廚房-中島','廚房-流理臺抽屜','廚房-米櫃','廚房-上方櫃','飯廳外-鞋櫃','客廳-鞋櫃','客廳-電視櫃','客廳-桌子','飯廳-藥櫃','飯廳-桌邊櫃','飯廳-餐具櫃','廁所1F'],"2F":['書房-書櫃A','書房-書櫃B','書房-抽屜','廁所2F','廁所2.5F','哥房間','妹房間','客房'],"3F":['休閒室','神廳','廁所3F','主臥'],"storage":['儲藏室A1','儲藏室A2','儲藏室A3','儲藏室A4','儲藏室A掛','儲藏室B1','儲藏室B2','儲藏室C','閣樓','2F儲藏室']}

          function  genPosition(){
            const areaS = document.getElementById('area')
            const posiS = document.getElementById('posi')
            const selectedArea = areaS.value

            // 刪除舊有位置清單
            posiS.innerHTML=''
            // 更新位置清單
            pos[selectedArea].forEach(position =>{
              const option = document.createElement('option')
              option.value = position
              option.textContent = position
              posiS.appendChild(option)
            })
          }
          // Attach event listener to first dropdown
          document.getElementById('area').addEventListener('change',genPosition)

          // Initial population on page load
          genPosition()
        </script>

        <div class="col-sm-2"></div>
        
      </div>

      <!-- 分隔線 -->
      <div style="height: 5px; width: 100%; background-color: #327570"></div>

      <div class="row">

        <!-- 價格 -->
        <div class="col-sm-4 form-group">          
          <input class="form-control" id="price" name="name"
          placeholder="價格" type="number">        
        </div>

        <!-- 新增數量 -->
        <div class="col-sm-4 form-group">          
          <input class="form-control" id="numAdd" name="name"
          placeholder="新增數量" type="number" required>        
        </div>

        <!-- 庫存下線 -->
        <div class="col-sm-4 form-group">          
          <input class="form-control" id="numMin" name="name"
          placeholder="下限庫存" type="number" required>        
        </div>
      </div>
        
      <br>
      <br>

      <div class="row">
        <div class="col-sm-2"></div>
        <div class="col-md-8 form-group">
          <button class="btn " type="button" id="submitButton" onclick="requireTest()">送出Submit</button>
          </div>
        <div class="col-sm-2"></div>
      </div>
    </form>
  </div>

  <!-- 重複物品表格在此 -->
  <div class="row">
    <div id="search-results" class="my-table-wrapper table-reponsive">  
    </div>
  </div>

  <!-- -二次確認模板 -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header">
            <h5 class="modal-title" id="confirmationModalLabel" style="color: black">Confirm Submission添加確認</h5>
            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <div class="modal-body">
            <!-- Display submitted data here -->
            <p id="modelContent" style="color: black; text-align: left"></p>
            
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">❌Cancel關閉</button>
            <button type="submit" class="btn btn-primary" id="confirmButton">⭕Confirm確認</button>
            <script>
              // 確認送出按下後
              document.getElementById('confirmButton')
                .addEventListener("click",getValues)
            </script>
        </div>
      </div>
    </div>
  </div>

  <!-- 左至右三區域第三區(空白) -->
  <!-- <div class="col-sm-2"></div> -->
  

</div>
</div>
<!-- 完成網頁顯示 -->
</body>

</html>







