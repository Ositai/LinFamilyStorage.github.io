<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº«å­˜æ¶ˆè€—</title>

    <!-- é€£æ¥boootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"> 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Include Bootstrap CSS JS for second confirm model-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
     
    <!-- è¼‰å…¥å…±ç”¨éƒ¨åˆ†ï¼Œéœæ…‹éƒ¨ç½²ç”¨ -->
    <link rel="stylesheet" href="https://ositai.github.io/LinFamilyStorage.github.io/LinFamiStorage/common.css">
    <script src="https://ositai.github.io/LinFamilyStorage.github.io/LinFamiStorage/common.js" defer></script>


    <script>
      // é¿å…è¡¨å–®ç©ºç™½
      function noBlank(){
        document.querySelector('form')   
          .addEventListener('submit',evt => {
            event.preventDefault()
          })      
        return undefined
      }
      window.addEventListener("load",noBlank,true)

      // é¡¯ç¤ºæœå°‹çµæœè¡¨æ ¼
      function displayResult(dataArray){
        if (dataArray && dataArray!==undefined && dataArray.length !=0){
          let dataArea = []
          let dataIndex = []
          // æ¶ˆè€—æ•¸é‡é¸æ“‡ æ¸…å–®é•·åº¦20
          let consumeList = Array.from({length: 20},(_,i) => i)
          let consumeListHTML = consumeList
            .map(num =>
              `<option value${num}>${num}</option>`
            ).join()


          // å¦‚æœæœ‰çµæœï¼Œå®šç¾©é¡¯ç¤ºæ ¼å¼
          let headerConsume = "<table class='table table-sm table-striped' id='dtable' style='font-size: 20px;'>"+
            "<thead style='white-space: nowrap;'>"+"<tr>"+
            // headers
            `${tableHeader}`+
            "<th scope='col'>æ¶ˆè€—æ•¸é‡</th>"+
            "</tr></thead>";

          let tableBody = ''
          // è¿´åœˆé¡¯ç¤ºè¡¨æ ¼å…ƒç´ ï¼Œä¸¦å„²å­˜areaèˆ‡index          
          dataArray.forEach((arr,idx) => {
            dataArea.push(arr.area)
            dataIndex.push(arr.index)

            // å–å¾—é™£åˆ—å…§å®¹è‡³htmlè¡¨æ ¼
            let tableRowBody = arr.data
              .map(dat => 
                `<td>${dat}</td>`
              ).join()

            tableBody +=  `<tr>${tableRowBody}<td>`+
                          `<select id="numConsume${idx}" class="form-control">`+
                          `${consumeListHTML}</select></td></tr>`              
          })

          let result = `${headerConsume}${tableBody}</table>`

          let div = document.getElementById('search-results')
          div.innerHTML = result
          div.style.display = 'block'

          // é¡¯ç¤ºæ›´æ–°åº«å­˜é‡æŒ‰éˆ•
          const showButton = document.getElementById('updateNum')
          showButton.style.display = 'block'

          // è¼¸å…¥é€²éš±è—è®Šæ•¸
          document.getElementById('dataArea').value = dataArea
          document.getElementById('dataIndex').value = dataIndex
        } else{
            let div = document.getElementById('search-results')
            div.innerHTML = 'æŸ¥ç„¡æ­¤åº«å­˜'
        }
        return undefined
      }

      // é¡¯ç¤ºäºŒæ¬¡ç¢ºèªè¦–çª—å…§æ–‡
      function checkModel(){
        let confirmArr = []
        let table = document.getElementById('dtable')
        
        for (i in table.rows){
          let numId = 'numConsume'+(i)
          let consumeNums = document.getElementById(numId).value
          if (consumeNums!=0){
            confirmArr.push({objName: table.rows[i+1].cells[0].textContent, consumeNums: consumeNums})
          }
        }
        let inputData = confirmArr
          .map(({objName,consumeNum}) =>
            `${objName} æ¶ˆè€—${consumeNum}å–®ä½`
          )
          .join('\n')

        document.getElementById('modelContent').innerText = inputData;
        $('#confirmationModal').modal('toggle')
      }

      // å‚³é€è³‡æ–™
      function getValues(){
        let area = document.getElementById('dataArea').value
        let index = document.getElementById('dataIndex').value
        let object = []

        for (let i in area){
          let numId = 'numConsume'+ i
          let consumeNums = document.getElementById(numId).value
          if (consumeNums!=0){
            object.push({area: area[i], index: index[i], num: consumeNums})
          }
        }

        // upload
        fetch(scriptUrl, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: JSON.stringify({
            action: 'remove',
            storageChange: object
            })
        })
        .then(res => res.json())
        .then(({success, message}) => {
          if (success) {
            // ä¸Šå‚³å®Œå¾Œæ¸…é™¤
            document.getElementById("search-results")
            .style
            .display = 'none'
            document.getElementById('updateNum')
            .style
            .display = 'none';

            // å®Œæˆç¢ºèªè¨Šæ¯
            alert(message)
          } else {
            console.error('Error sending data to Google Sheets:', message);
          }
        })
        .catch(error => {
          console.error('Fetch error:', error);
        });

        // é—œé–‰äºŒæ¬¡ç¢ºèªå°è©±æ¡†
        bootstrap.Modal
          .getInstance(document
            .getElementById('confirmationModal')
          )
        .hide()
        return undefined
      }
    </script>
  </head>

  <body>
    <div class="container-contact">
    <h2 style="text-align: center;">LinFamiStorage</h2>
    <div class="row">
      <div class="col-sm-2"></div>
      <div class="col-md-8">
        <h3 style="text-align: center;">åº«å­˜æ¶ˆè€—</h3>
      </div>
      <div class="col-sm-2" style="text-align: right;">
        <button class="btn" style="font-size: 20px; max-width: fit-content;" id="backHome" onclick="linkToAdd('home')">
          ğŸ  Home</button>
      </div>
    </div>
    <br>

      <!-- éš±è—è®Šæ•¸ -->
      <span id="dataArea" style="display: none;"></span>
      <span id="dataIndex" style="display: none;"></span>

      <!-- æœå°‹è¡¨å–® -->
      <div class="row">
        <form id="search-form" class="form-group" onsubmit="formSender(this);">
          <input style="width: 60%;" type="text" id="searchtext" name="searchtext" placeholder="è«‹è¼¸å…¥æ¶ˆè€—ç‰©å“">
          <button type="submit" class="btn btn-primary">ğŸ”æœå°‹Search</button>
        </form>
      </div>

      <!-- è¡¨æ ¼åœ¨æ­¤ -->
     <div class="row">
        <div id="search-results" class="table-reponsive">  
        </div>
     </div>
     

      <!-- å‚³é€ä¿®æ”¹çµæœæŒ‰éˆ• -->
      <div class="row">
        <div class="col-sm-5"></div>
        <div class="col-sm-5">
        <button class="btn" style="width: 100%; display: none;" id='updateNum' onclick="checkModel()">é€å‡ºä¿®æ”¹</button></div>
      </div>

      <!-- -äºŒæ¬¡ç¢ºèªæ¨¡æ¿ -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header">
            <h5 class="modal-title" id="confirmationModalLabel" style="color: black">Consume Submissionæ¶ˆè€—ç¢ºèª</h5>
            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <div class="modal-body">
            <!-- Display submitted data here -->
            <p id="modelContent" style="color: black; text-align: left"></p>
            
        </div>

        <div class="rows">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">âŒCancelé—œé–‰</button>
            <button type="submit" class="btn btn-primary" id="confirmButton">â­•Confirmç¢ºèª</button>
            <script>
              // è§¸ç™¼
              document.getElementById('confirmButton')
                .addEventListener("click",getValues)
            </script>
        </div>
      </div>
    </div>
  </div>
  </div>   
  </body>
</html>





