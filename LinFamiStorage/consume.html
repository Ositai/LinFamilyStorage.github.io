<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>庫存消耗</title>

    <!-- Include Bootstrap CSS JS for second confirm model-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj" crossorigin="anonymous"></script>
    
    <!-- 載入共用部分，靜態部署用 -->
    <link rel="stylesheet" href="https://ositai.github.io/LinFamilyStorage.github.io/LinFamiStorage/common.css">
    <script src="https://ositai.github.io/LinFamilyStorage.github.io/LinFamiStorage/common.js" defer></script>


    <script>
      // 避免表單空白
      function noBlank(){
        document.querySelector('form')   
          .addEventListener('submit',evt => {
            event.preventDefault()
          })      
        return undefined
      }
      window.addEventListener("load",noBlank,true)

      // 顯示搜尋結果表格
      function displayResult(dataArray){
        if (dataArray && dataArray!==undefined && dataArray.length !=0){
          let dataArea = []
          let dataIndex = []
          // 消耗數量選擇 清單長度20
          let consumeList = Array.from({length: 20},(_,i) => i)
          let consumeListHTML = consumeList
            .map(num =>
              `<option value${num}>${num}</option>`
            ).join()


          // 如果有結果，定義顯示格式
          let headerConsume = "<table class='table table-sm table-striped' id='dtable' style='font-size: 20px;'>"+
            "<thead style='white-space: nowrap;'>"+"<tr>"+
            // headers
            `${tableHeader}`+
            "<th scope='col'>消耗數量</th>"+
            "</tr></thead>";

          let tableBody = ''
          // 迴圈顯示表格元素，並儲存area與index          
          dataArray.forEach((arr,idx) => {
            dataArea.push(arr.area)
            dataIndex.push(arr.index)

            // 取得陣列內容至html表格
            let tableRowBody = arr.data
              .map(dat => 
                `<td>${dat}</td>`
              ).join()

            tableBody +=  `<tr>${tableRowBody}<td>`+
                          `<select id="numConsume${idx}" class="form-control">`+
                          `${consumeListHTML}</select></td></tr>`              
          })

          let result = `${headerConsume}${tableBody}</table>`

          let div = document.getElementById('search-results')
          div.innerHTML = result
          div.style.display = 'block'

          // 顯示更新庫存量按鈕
          const showButton = document.getElementById('updateNum')
          showButton.style.display = 'block'

          // 輸入進隱藏變數
          document.getElementById('dataArea').value = dataArea
          document.getElementById('dataIndex').value = dataIndex
        } else{
            let div = document.getElementById('search-results')
            div.innerHTML = '查無此庫存'
        }
        return undefined
      }

      // 顯示二次確認視窗內文
      function checkModel(){
        let confirmArr = []
        let table = document.getElementById('dtable')
        
        for (i in table.rows){
          let numId = 'numConsume'+(i)
          let consumeNums = document.getElementById(numId).value
          if (consumeNums!=0){
            confirmArr.push({objName: table.rows[i+1].cells[0].textContent, consumeNums: consumeNums})
          }
        }
        let inputData = confirmArr
          .map(({objName,consumeNum}) =>
            `${objName} 消耗${consumeNum}單位`
          )
          .join('\n')

        document.getElementById('modelContent')
          .innerText = inputData

        // 顯示二次確認視窗
        new bootstrap.Modal(document
          .getElementById('confirmationModal'))
        .show()
      }

      // 傳送資料
      function getValues(){
        let area = document.getElementById('dataArea').value
        let index = document.getElementById('dataIndex').value
        let object = []

        for (let i in area){
          let numId = 'numConsume'+ i
          let consumeNums = document.getElementById(numId).value
          if (consumeNums!=0){
            object.push({area: area[i], index: index[i], num: consumeNums})
          }
        }

        // upload
        fetch(scriptUrl, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: JSON.stringify({
            action: 'remove',
            storageChange: object
            })
        })
        .then(res => res.json())
        .then(({success, message}) => {
          if (success) {
            // 上傳完後清除
            document.getElementById("search-results")
            .style
            .display = 'none'
            document.getElementById('updateNum')
            .style
            .display = 'none';

            // 完成確認訊息
            alert(message)
          } else {
            console.error('Error sending data to Google Sheets:', message);
          }
        })
        .catch(error => {
          console.error('Fetch error:', error);
        });

        // 關閉二次確認對話框
        bootstrap.Modal.getInstance(document
          .getElementById('confirmationModal')
        ).hide()
        return undefined
      }
    </script>
  </head>

  <body>
    <div class="container-contact">
    <h2 style="text-align: center;">LinFamiStorage</h2>
    <div class="row">
      <div class="col-sm-2"></div>
      <div class="col-md-8">
        <h3 style="text-align: center;">庫存消耗</h3>
      </div>
      <div class="col-sm-2" style="text-align: right;">
        <button class="btn" style="font-size: 20px; max-width: fit-content;" id="backHome" onclick="linkToAdd('home')">
          🏠 Home</button>
      </div>
    </div>
    <br>

      <!-- 隱藏變數 -->
      <span id="dataArea" style="display: none;"></span>
      <span id="dataIndex" style="display: none;"></span>

      <!-- 搜尋表單 -->
      <div class="row">
        <form id="search-form" class="form-group" onsubmit="formSender(this);">
          <input style="width: 60%;" type="text" id="searchtext" name="searchtext" placeholder="請輸入消耗物品">
          <button type="submit" class="btn btn-primary">🔍搜尋Search</button>
        </form>
      </div>

      <!-- 表格在此 -->
     <div class="row">
        <div id="search-results" class="table-reponsive">  
        </div>
     </div>
     

      <!-- 傳送修改結果按鈕 -->
      <div class="row">
        <div class="col-sm-5"></div>
        <div class="col-sm-5">
        <button class="btn" style="width: 100%; display: none;" id='updateNum' onclick="checkModel()">送出修改</button></div>
      </div>

      <!-- -二次確認模板 -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header">
            <h5 class="modal-title" id="confirmationModalLabel" style="color: black">Consume Submission消耗確認</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <div class="modal-body">
            <!-- Display submitted data here -->
            <p id="modelContent" style="color: black; text-align: left"></p>
            
        </div>

        <div class="rows">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">❌Cancel關閉</button>
            <button type="submit" class="btn btn-primary" id="confirmButton">⭕Confirm確認</button>
            <script>
              // 觸發
              document.getElementById('confirmButton')
                .addEventListener("click",getValues)
            </script>
        </div>
      </div>
    </div>
  </div>
  </div>   
  </body>
</html>









